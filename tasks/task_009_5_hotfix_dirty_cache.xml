<smartchrome_task id="009_5" status="success">
  <context>
    Our VLMSensor is crashing the renderer because it reads the Accessibility tree synchronously inside DidMeaningfulLayout while the AXObjectCache is still dirty. We need to refactor VLMSensor to use base::SingleThreadTaskRunner::GetCurrentDefault()->PostDelayedTask to read the tree 500ms AFTER the layout event, allowing Blink to finish its lifecycle updates.
  </context>

  <phase_1_project_management>
    <description>Save this prompt to ~/SmartChrome/tasks/task_009_5_hotfix_dirty_cache.txt</description>
    <actions>
      <action>Status: Completed</action>
      <action>File: tasks/task_009_5_hotfix_dirty_cache.txt</action>
    </actions>
  </phase_1_project_management>

  <phase_2_chromium_c_plus_plus_hotfix>
    <description>Refactor VLMSensor to use PostDelayedTask.</description>
    <actions>
      <action>Updated components/vlm_agent/renderer/vlm_sensor.h: Added base::memory::weak_ptr.h, DoCaptureAndSend(), and WeakPtrFactory.</action>
      <action>Updated components/vlm_agent/renderer/vlm_sensor.cc:
        - Included base/task/single_thread_task_runner.h and base/location.h.
        - Refactored DidMeaningfulLayout to PostDelayedTask to DoCaptureAndSend with a 500ms delay.
        - Implemented DoCaptureAndSend with frame lifecycle safety checks.
      </action>
      <action>Built entire browser: autoninja -C out/Default chrome</action>
    </actions>
  </phase_2_chromium_c_plus_plus_hotfix>

  <execution_log>
    Build status: Success
    Chrome binary: ~/chromium/src/out/Default/chrome
    Completion time: 2026-02-27 20:08:29
    Note: The 500ms delay safely decouples the A11y tree read from the synchronous layout event, preventing crashes due to dirty AX caches.
  </execution_log>
</smartchrome_task>
